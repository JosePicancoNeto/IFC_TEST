<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IFC Interactive Viewer</title>

  <style>
    :root{
      --bg1:#040a16; --bg2:#0b1a3a;
      --panel:rgba(17,24,39,.55);
      --panel2:rgba(17,24,39,.35);
      --stroke:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.88);
      --muted:rgba(255,255,255,.66);
      --btn:rgba(255,255,255,.08);
      --btn2:rgba(255,255,255,.12);
      --shadow:0 12px 40px rgba(0,0,0,.35);
      --r:16px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    html,body{height:100%; margin:0;}
    body{
      background: radial-gradient(1200px 700px at 30% 20%, var(--bg2), var(--bg1));
      color:var(--text);
      overflow:hidden;
    }
    #app{position:fixed; inset:0;}
    canvas{display:block; width:100%; height:100%;}
    .topbar{
      position:fixed; top:16px; left:16px; right:16px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      pointer-events:none;
    }
    .brand{
      pointer-events:auto;
      display:flex; flex-direction:column; gap:2px;
      padding:10px 12px; border-radius:999px;
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      max-width:min(560px, 92vw);
    }
    .brand .title{font-weight:700; font-size:14px;}
    .brand .sub{font-size:12px; color:var(--muted);}
    .actions{
      pointer-events:auto;
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }
    .btn{
      appearance:none; border:1px solid var(--stroke);
      background:var(--btn); color:var(--text);
      padding:8px 10px; border-radius:999px;
      cursor:pointer; font-size:12px;
      backdrop-filter: blur(10px);
    }
    .btn:hover{background:var(--btn2);}
    .btn.primary{border-color: rgba(34,197,94,.4); background: rgba(34,197,94,.18);}
    .btn.primary:hover{background: rgba(34,197,94,.28);}
    .bottom{
      position:fixed; left:16px; bottom:16px; right:16px;
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      pointer-events:none;
    }
    .panel{
      pointer-events:auto;
      width:min(620px, 92vw);
      padding:12px 12px 10px;
      border-radius: var(--r);
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .hint{margin-top:8px; font-size:12px; color:var(--muted); line-height:1.35;}
    #status{
      pointer-events:auto;
      padding:8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
      border:1px solid var(--stroke);
      font-size:12px;
      color:var(--muted);
      backdrop-filter: blur(10px);
    }
    input[type="file"]{display:none;}
    @media (max-width: 640px){
      .topbar{top:12px; left:12px; right:12px;}
      .bottom{left:12px; right:12px; bottom:12px; flex-direction:column; align-items:stretch;}
      #status{align-self:flex-end;}
    }
  </style>

  <!-- Importmap: resolve "three" e "web-ifc-three" sem bundler (GitHub Pages friendly) -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/examples/jsm/": "https://unpkg.com/three@0.160.0/examples/jsm/",
      "web-ifc": "https://unpkg.com/web-ifc@0.0.44/web-ifc-api.js",
      "web-ifc-three": "https://unpkg.com/web-ifc-three@0.0.125/IFCLoader.js"
    }
  }
  </script>
</head>

<body>
  <div id="app">
    <canvas id="c"></canvas>
  </div>

  <div class="topbar">
    <div class="brand">
      <div class="title">IFC Interactive Viewer</div>
      <div class="sub">Revit → IFC • abre IFC padrão e permite carregar outro IFC local</div>
    </div>
    <div class="actions">
      <button class="btn" id="resetBtn">Reset view</button>
      <button class="btn" id="fitBtn">Fit model</button>
      <button class="btn" id="bgBtn">Toggle background</button>
      <button class="btn primary" id="fsBtn">Fullscreen</button>
    </div>
  </div>

  <div class="bottom">
    <div class="panel">
      <div class="row">
        <button class="btn" id="openBtn">Open IFC</button>
        <label class="btn" for="fileInput">Escolher ficheiro</label>
        <input id="fileInput" type="file" accept=".ifc,application/octet-stream" />
        <button class="btn" id="clearBtn">Clear</button>
      </div>
      <div class="hint">
        • O modelo padrão <b>ALL_ACESS.ifc</b> abre automaticamente (se estiver na mesma pasta do <b>index.html</b>).<br/>
        • Também podes arrastar e soltar um IFC na página ou escolher um ficheiro local.<br/>
        • Ideal para LinkedIn: o cliente abre o link e pode carregar o IFC localmente.
      </div>
    </div>
    <div id="status">Ready</div>
  </div>

  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/examples/jsm/controls/OrbitControls.js";
    import { IFCLoader } from "web-ifc-three";

    const canvas = document.getElementById("c");
    const statusEl = document.getElementById("status");
    const setStatus = (msg) => (statusEl.textContent = msg);

    // --- Renderer / scene
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);

    const scene = new THREE.Scene();

    const camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.05, 2000);
    camera.position.set(10, 8, 12);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;
    controls.target.set(0, 1, 0);

    // Lights (evita modelo “preto”)
    scene.add(new THREE.HemisphereLight(0xffffff, 0x223344, 1.2));
    const dir = new THREE.DirectionalLight(0xffffff, 1.0);
    dir.position.set(6, 10, 4);
    scene.add(dir);

    // Background toggle
    let bgMode = 0;
    function setBackground() {
      if (bgMode === 0) scene.background = null;
      if (bgMode === 1) scene.background = new THREE.Color(0x0b1020);
      if (bgMode === 2) scene.background = new THREE.Color(0xffffff);
    }
    setBackground();

    // Subtle grid
    const grid = new THREE.GridHelper(40, 40, 0x335577, 0x223344);
    grid.material.opacity = 0.22;
    grid.material.transparent = true;
    scene.add(grid);

    // --- IFC Loader (web-ifc-three)
    const ifcLoader = new IFCLoader();

    // MUST point to folder containing web-ifc.wasm
    ifcLoader.ifcManager.setWasmPath("https://unpkg.com/web-ifc@0.0.44/");
    // Workers for performance
    ifcLoader.ifcManager.useWebWorkers(true, "https://unpkg.com/web-ifc@0.0.44/");

    let currentModel = null;

    function clearModel() {
      if (!currentModel) return;
      scene.remove(currentModel);

      currentModel.traverse?.((obj) => {
        obj.geometry?.dispose?.();
        if (obj.material) {
          const mats = Array.isArray(obj.material) ? obj.material : [obj.material];
          mats.forEach((m) => m.dispose?.());
        }
      });

      currentModel = null;
    }

    function fitToObject(obj) {
      const box = new THREE.Box3().setFromObject(obj);
      if (box.isEmpty()) return;

      const size = new THREE.Vector3();
      const center = new THREE.Vector3();
      box.getSize(size);
      box.getCenter(center);

      const maxDim = Math.max(size.x, size.y, size.z);
      const fov = (camera.fov * Math.PI) / 180;
      let cameraZ = Math.abs((maxDim / 2) / Math.tan(fov / 2));
      cameraZ *= 1.35;

      camera.position.set(center.x + cameraZ, center.y + cameraZ * 0.55, center.z + cameraZ);
      camera.near = Math.max(0.01, maxDim / 200);
      camera.far = Math.max(2000, maxDim * 10);
      camera.updateProjectionMatrix();

      controls.target.copy(center);
      controls.update();
    }

    function loadIFCFromURL(url) {
      return new Promise((resolve, reject) => {
        setStatus("Carregando IFC…");
        ifcLoader.load(
          url,
          (ifcModel) => {
            clearModel();
            currentModel = ifcModel;
            scene.add(ifcModel);
            fitToObject(ifcModel);
            setStatus("Ready");
            resolve(ifcModel);
          },
          (xhr) => {
            if (xhr?.total) {
              const p = Math.round((xhr.loaded / xhr.total) * 100);
              setStatus(`Carregando… ${p}%`);
            } else {
              setStatus("Carregando…");
            }
          },
          (err) => {
            console.error(err);
            setStatus("Erro ao carregar IFC (ver console)");
            reject(err);
          }
        );
      });
    }

    async function loadIFCFile(file) {
      // Blob URL evita CORS e funciona no GitHub Pages
      const blobURL = URL.createObjectURL(file);
      try {
        await loadIFCFromURL(blobURL);
      } finally {
        URL.revokeObjectURL(blobURL);
      }
    }

    const DEFAULT_IFC = "ALL_ACESS.ifc";

    async function tryLoadDefault() {
      try {
        setStatus("Verificando IFC padrão…");
        // HEAD dá feedback “limpo” se o ficheiro não estiver acessível
        const res = await fetch(DEFAULT_IFC, { method: "HEAD" });
        if (!res.ok) throw new Error(`HEAD ${res.status}`);
        await loadIFCFromURL(DEFAULT_IFC);
      } catch (e) {
        console.warn("Default IFC not loaded:", e);
        setStatus("Ready (IFC padrão não encontrado)");
      }
    }

    // --- UI events
    document.getElementById("openBtn").addEventListener("click", () => document.getElementById("fileInput").click());
    document.getElementById("fileInput").addEventListener("change", async (ev) => {
      const file = ev.target.files?.[0];
      if (!file) return;
      await loadIFCFile(file);
      ev.target.value = "";
    });

    document.getElementById("clearBtn").addEventListener("click", () => {
      clearModel();
      setStatus("Ready");
    });

    document.getElementById("fitBtn").addEventListener("click", () => {
      if (currentModel) fitToObject(currentModel);
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      controls.reset();
      camera.position.set(10, 8, 12);
      controls.target.set(0, 1, 0);
      controls.update();
    });

    document.getElementById("bgBtn").addEventListener("click", () => {
      bgMode = (bgMode + 1) % 3;
      setBackground();
    });

    document.getElementById("fsBtn").addEventListener("click", async () => {
      try {
        if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
        else await document.exitFullscreen();
      } catch (_) {}
    });

    // Drag & drop
    window.addEventListener("dragover", (e) => e.preventDefault());
    window.addEventListener("drop", async (e) => {
      e.preventDefault();
      const file = e.dataTransfer?.files?.[0];
      if (file && file.name.toLowerCase().endsWith(".ifc")) await loadIFCFile(file);
    });

    // Resize
    window.addEventListener("resize", () => {
      renderer.setSize(window.innerWidth, window.innerHeight);
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
    });

    // Loop
    renderer.setAnimationLoop(() => {
      controls.update();
      renderer.render(scene, camera);
    });

    // Start
    await tryLoadDefault();
  </script>
</body>
</html>
