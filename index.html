<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IFC Viewer (Revit) • Upload local</title>
  <style>
    :root{
      --bg:#0b1220;
      --glass:rgba(255,255,255,.10);
      --glass2:rgba(0,0,0,.42);
      --border:rgba(255,255,255,.16);
      --text:#ffffff;
      --muted:rgba(255,255,255,.72);
      --shadow:0 18px 45px rgba(2,6,23,.45);
      --radius:14px;
      --accent:#16a34a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(900px 450px at 50% -20%, rgba(22,163,74,.25), transparent 60%),
        radial-gradient(900px 450px at 110% 0%, rgba(59,130,246,.18), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      overflow:hidden;
    }
    #app{position:relative; width:100%; height:100%;}
    #canvas{display:block; width:100%; height:100%;}
    .topbar{
      position:absolute; left:14px; right:14px; top:14px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      z-index:10;
      pointer-events:none;
    }
    .brand{
      pointer-events:auto;
      display:flex; align-items:center; gap:10px;
      background:var(--glass);
      border:1px solid var(--border);
      border-radius:999px;
      padding:10px 12px;
      backdrop-filter: blur(10px);
    }
    .logo{
      width:28px; height:28px; border-radius:10px;
      display:inline-flex; align-items:center; justify-content:center;
      background:rgba(22,163,74,.22);
      border:1px solid rgba(22,163,74,.35);
      font-weight:900;
      color:#d1fae5;
    }
    .brandText{line-height:1.05}
    .brandText b{display:block; font-size:13px; letter-spacing:.2px}
    .brandText span{display:block; font-size:12px; color:var(--muted)}
    .actions{
      pointer-events:auto;
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }
    .btn{
      appearance:none;
      border:1px solid var(--border);
      background:var(--glass);
      color:#fff;
      border-radius:12px;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
      backdrop-filter: blur(10px);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{border-color:rgba(255,255,255,.28); background:rgba(255,255,255,.14)}
    .btn.primary{
      background:rgba(22,163,74,.22);
      border-color:rgba(22,163,74,.45);
    }
    .btn.primary:hover{background:rgba(22,163,74,.28)}
    .panel{
      position:absolute;
      left:14px; right:14px; bottom:14px;
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      z-index:10;
      pointer-events:none;
    }
    .card{
      pointer-events:auto;
      background:rgba(255,255,255,.92);
      color:#0f172a;
      border:1px solid rgba(15,23,42,.14);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:12px;
      max-width:980px;
      width:min(980px, 100%);
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{
      font-size:12px; font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.10);
      background:#f8fafc;
      color:#0f172a;
      white-space:nowrap;
    }
    .hint{
      font-size:12px;
      color:#475569;
      line-height:1.35;
      margin-top:8px;
    }
    .status{
      pointer-events:auto;
      background:var(--glass2);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      backdrop-filter: blur(10px);
      max-width:520px;
      color:rgba(255,255,255,.92);
      box-shadow: var(--shadow);
    }
    .status b{display:block; font-size:13px}
    .status span{display:block; font-size:12px; color:var(--muted); margin-top:3px}
    .drop{
      position:absolute; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background:rgba(2,6,23,.55);
      z-index:20;
      pointer-events:none;
    }
    .drop .box{
      pointer-events:none;
      border:2px dashed rgba(255,255,255,.35);
      border-radius:18px;
      padding:18px 20px;
      background:rgba(255,255,255,.08);
      text-align:center;
    }
    .drop .box b{display:block; font-size:16px}
    .drop .box span{display:block; font-size:13px; color:rgba(255,255,255,.75); margin-top:6px}
    @media (max-width: 820px){
      .topbar{left:10px; right:10px; top:10px}
      .panel{left:10px; right:10px; bottom:10px; flex-direction:column; align-items:stretch}
      .status{max-width:none}
      .card{max-width:none}
    }
  </style>
</head>
<body>
<div id="app">
  <canvas id="canvas"></canvas>

  <div class="topbar">
    <div class="brand">
      <div class="logo">IFC</div>
      <div class="brandText">
        <b>Interactive IFC Viewer</b>
        <span>Revit → IFC • upload local (sem link)</span>
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="btnReset">Reset view</button>
      <button class="btn" id="btnFit">Fit model</button>
      <button class="btn" id="btnBg">Toggle background</button>
      <button class="btn primary" id="btnFullscreen">Fullscreen</button>
    </div>
  </div>

  <div class="panel">
    <div class="card">
      <div class="row">
        <div class="pill">Open IFC</div>

        <label class="btn primary" style="margin:0;">
          <input id="filePick" type="file" accept=".ifc" style="display:none" />
          Escolher ficheiro
        </label>

        <button class="btn" id="btnClear">Clear</button>
      </div>

      <div class="hint">
        • O modelo padrão <b>ALL_ACESS.ifc</b> abre automaticamente (se estiver na mesma pasta do HTML).<br>• Você pode arrastar e soltar outro <b>.ifc</b> nesta página, ou clicar em “Escolher ficheiro”.<br>
        • Para publicar no LinkedIn: coloque o link desta página e diga ao cliente para abrir o IFC no browser.
        (Por questões de segurança do navegador, o IFC é escolhido localmente pelo utilizador.)
      </div>
    </div>

    <div class="status" id="status">
      <b>Ready</b>
      <span>Abra um IFC. Use mouse/touch para orbitar/zoom/pan.</span>
    </div>
  </div>

  <div class="drop" id="drop">
    <div class="box">
      <b>Solte o seu IFC aqui</b>
      <span>O ficheiro abre localmente no viewer</span>
    </div>
  </div>
</div>

<script type="module">
  import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
  import { OrbitControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";
  import { IFCLoader } from "https://unpkg.com/three@0.160.0/examples/jsm/loaders/IFCLoader.js";

  // Default IFC shipped with the page (place ALL_ACESS.ifc in the same folder as this HTML on GitHub Pages)
  const DEFAULT_IFC_URL = "./ALL_ACESS.ifc";

  const canvas = document.getElementById("canvas");
  const statusEl = document.getElementById("status");
  const filePick = document.getElementById("filePick");
  const drop = document.getElementById("drop");

  const scene = new THREE.Scene();
  let solidBg = false;

  const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.0;

  const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.05, 5000);
  camera.position.set(10, 8, 14);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.06;
  controls.screenSpacePanning = true;
  controls.minDistance = 0.1;
  controls.maxDistance = 2000;

  // Lights
  scene.add(new THREE.HemisphereLight(0xffffff, 0x1f2937, 0.85));

  const key = new THREE.DirectionalLight(0xffffff, 1.2);
  key.position.set(16, 22, 14);
  scene.add(key);

  const fill = new THREE.DirectionalLight(0xffffff, 0.55);
  fill.position.set(-18, 10, -16);
  scene.add(fill);

  const rim = new THREE.DirectionalLight(0xffffff, 0.35);
  rim.position.set(-2, 14, 22);
  scene.add(rim);

  // Loader
  const ifcLoader = new IFCLoader();

  // Use web-ifc WASM from CDN
  // (Se preferir offline, você pode copiar web-ifc.wasm para o seu repo e apontar para "./wasm/")
  ifcLoader.ifcManager.setWasmPath("https://unpkg.com/web-ifc@0.0.75/");

  let model = null;

  function setStatus(title, subtitle){
    statusEl.querySelector("b").textContent = title;
    statusEl.querySelector("span").textContent = subtitle || "";
  }

  function disposeModel(obj){
    obj.traverse(o => {
      if(o.geometry) o.geometry.dispose();
      if(o.material){
        const mats = Array.isArray(o.material) ? o.material : [o.material];
        mats.forEach(m => m.dispose());
      }
    });
  }

  function clearModel(){
    if(!model) return;
    scene.remove(model);
    disposeModel(model);
    model = null;
  }

  function fitToObject(obj){
    const box = new THREE.Box3().setFromObject(obj);
    const size = box.getSize(new THREE.Vector3());
    const center = box.getCenter(new THREE.Vector3());

    const maxDim = Math.max(size.x, size.y, size.z);
    const fov = camera.fov * (Math.PI / 180);
    let dist = maxDim / (2 * Math.tan(fov / 2));
    dist *= 1.25;

    const dir = new THREE.Vector3().subVectors(camera.position, controls.target).normalize();
    camera.position.copy(center).add(dir.multiplyScalar(dist));
    camera.near = Math.max(0.01, dist / 200);
    camera.far  = dist * 200;
    camera.updateProjectionMatrix();

    controls.target.copy(center);
    controls.update();
  }

  async function openIfcUrl(url, label){
    clearModel();
    setStatus("Loading…", `A abrir IFC: ${label || url} …`);

    try{
      const ifcModel = await ifcLoader.loadAsync(url);

      model = ifcModel;
      scene.add(model);

      // IFC models sometimes appear dark; keep materials opaque
      model.traverse(o => {
        if(o.isMesh && o.material){
          o.material.transparent = false;
          o.material.opacity = 1;
        }
      });

      fitToObject(model);
      setStatus("Ready", `Carregado: ${label || url}`);
    }catch(err){
      console.error(err);
      setStatus("Error", "Falha ao abrir IFC. Verifique o ficheiro e tente novamente.");
    }
  }

  async function openIfcFile(file){
    if(!file) return;
    if(!file.name.toLowerCase().endsWith(".ifc")){
      setStatus("Formato inválido", "Escolha um ficheiro .ifc exportado do Revit.");
      return;
    }

    // Create an Object URL for the local file
    const url = URL.createObjectURL(file);
    await openIfcUrl(url, file.name);
    // Revoke later to free memory
    setTimeout(() => URL.revokeObjectURL(url), 60_000);
  }


  // UI actions
  document.getElementById("btnReset").addEventListener("click", () => {
    camera.position.set(10,8,14);
    controls.target.set(0,0,0);
    controls.update();
  });

  document.getElementById("btnFit").addEventListener("click", () => {
    if(model) fitToObject(model);
  });

  document.getElementById("btnBg").addEventListener("click", () => {
    solidBg = !solidBg;
    renderer.setClearColor(0x0b1220, solidBg ? 1 : 0);
  });

  document.getElementById("btnFullscreen").addEventListener("click", async () => {
    const el = document.getElementById("app");
    if(!document.fullscreenElement){
      await el.requestFullscreen?.();
    } else {
      await document.exitFullscreen?.();
    }
  });

  document.getElementById("btnClear").addEventListener("click", () => {
    clearModel();
    setStatus("Ready", "Abra um IFC. Use mouse/touch para orbitar/zoom/pan.");
  });

  filePick.addEventListener("change", (e) => {
    const file = e.target.files?.[0];
    if(file) openIfcFile(file);
    filePick.value = "";
  });

  // Drag & drop
  window.addEventListener("dragover", (e) => { e.preventDefault(); drop.style.display = "flex"; });
  window.addEventListener("dragleave", () => { drop.style.display = "none"; });
  window.addEventListener("drop", (e) => {
    e.preventDefault();
    drop.style.display = "none";
    const file = e.dataTransfer?.files?.[0];
    if(file) openIfcFile(file);
  });

  // Resize
  window.addEventListener("resize", () => {
    renderer.setSize(window.innerWidth, window.innerHeight);
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  });

  renderer.setClearColor(0x0b1220, 0);

  // Auto-load default IFC on page open (if present on the server)
  (async () => {
    try{
      setStatus("Loading…", "A abrir modelo padrão (ALL_ACESS.ifc) …");
      await openIfcUrl(DEFAULT_IFC_URL, "ALL_ACESS.ifc");
    }catch{
      // If default file is missing (404) or blocked, keep viewer usable for local upload
      setStatus("Ready", "Modelo padrão não encontrado. Abra um IFC local para visualizar.");
    }
  })();


  function animate(){
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }
  animate();
</script>
</body>
</html>
