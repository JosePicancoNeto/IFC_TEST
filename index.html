<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IFC Interactive Viewer</title>

  <!-- Importmap support (inclui browsers que ainda têm limitações) -->
  <script async src="https://unpkg.com/es-module-shims@1.10.0/dist/es-module-shims.js"></script>

  <!-- IMPORTMAP: resolve "three" e "three/addons/*" corretamente -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>

  <style>
    :root{
      --bg1:#030a1a;
      --bg2:#061331;
      --panel: rgba(0,0,0,.35);
      --panel2: rgba(255,255,255,.06);
      --text: rgba(255,255,255,.90);
      --muted: rgba(255,255,255,.70);
      --btn: rgba(255,255,255,.10);
      --btn2: rgba(255,255,255,.16);
      --accent: #2dd4bf;
    }
    html,body{height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background: radial-gradient(1200px 700px at 30% 20%, #081a3d 0%, var(--bg1) 55%, #020713 100%); overflow:hidden;}
    #app{position:fixed; inset:0; display:block;}
    canvas{position:absolute; inset:0; width:100%; height:100%; display:block;}

    .topbar{
      position:absolute; left:16px; top:16px;
      color:var(--text);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      border-radius:14px;
      padding:10px 12px;
      backdrop-filter: blur(10px);
      max-width:min(520px, calc(100vw - 32px));
    }
    .title{display:flex; gap:10px; align-items:flex-start;}
    .badge{
      width:28px; height:28px; border-radius:9px;
      background: rgba(255,255,255,.12);
      display:grid; place-items:center;
      font-weight:800; letter-spacing:.5px;
    }
    .title h1{font-size:14px; margin:0; line-height:1.1;}
    .title p{margin:2px 0 0; font-size:12px; color:var(--muted);}

    .actions{
      position:absolute; right:16px; top:16px;
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
      max-width: calc(100vw - 32px);
    }
    .btn{
      appearance:none; border:1px solid rgba(255,255,255,.12);
      background:var(--btn); color:var(--text);
      padding:8px 10px; border-radius:12px;
      font-size:12px; cursor:pointer;
      backdrop-filter: blur(10px);
      transition:.15s ease;
      user-select:none;
    }
    .btn:hover{background:var(--btn2);}
    .btn.primary{border-color: rgba(45,212,191,.40); background: rgba(45,212,191,.14);}
    .btn.primary:hover{background: rgba(45,212,191,.20);}

    .panel{
      position:absolute; left:16px; bottom:16px;
      width:min(520px, calc(100vw - 32px));
      color:var(--text);
      background: linear-gradient(180deg, rgba(0,0,0,.42), rgba(0,0,0,.28));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      border-radius:16px;
      padding:12px;
      backdrop-filter: blur(10px);
    }
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .row .btn{padding:9px 10px;}
    .hint{margin-top:10px; font-size:12px; color:var(--muted); line-height:1.35;}
    .hint code{background: rgba(255,255,255,.08); padding:2px 6px; border-radius:8px; color:var(--text);}
    .status{
      position:absolute; right:16px; bottom:16px;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      border-radius:12px;
      padding:8px 10px;
      font-size:12px;
      backdrop-filter: blur(10px);
      max-width: calc(100vw - 32px);
    }
    .toast{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom:18px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-size:12px;
      opacity:0; pointer-events:none;
      transition:.18s ease;
      backdrop-filter: blur(10px);
      max-width: min(740px, calc(100vw - 32px));
      text-align:center;
    }
    .toast.show{opacity:1;}
    input[type="file"]{display:none;}
  </style>
</head>

<body>
  <div id="app">
    <canvas id="c"></canvas>

    <div class="topbar">
      <div class="title">
        <div class="badge">IFC</div>
        <div>
          <h1>IFC Interactive Viewer</h1>
          <p>Revit → IFC • abre um IFC padrão + permite carregar outro ficheiro local</p>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn" id="resetBtn">Reset view</button>
      <button class="btn" id="fitBtn">Fit model</button>
      <button class="btn" id="bgBtn">Toggle background</button>
      <button class="btn primary" id="fsBtn">Fullscreen</button>
    </div>

    <div class="panel">
      <div class="row">
        <button class="btn primary" id="openBtn">Open IFC</button>
        <label class="btn" for="fileInput">Escolher ficheiro</label>
        <button class="btn" id="clearBtn">Clear</button>
        <input id="fileInput" type="file" accept=".ifc,model/ifc" />
      </div>

      <div class="hint">
        • O modelo padrão <code>ALL_ACESS.ifc</code> abre automaticamente (se estiver na mesma pasta do HTML no GitHub Pages).<br/>
        • Você também pode arrastar e soltar um IFC nesta página, ou clicar em <code>Escolher ficheiro</code>.<br/>
        • Para LinkedIn: coloque o link desta página no post e peça ao cliente para abrir no browser (o IFC pode ser escolhido localmente).
      </div>
    </div>

    <div class="status" id="status">Ready</div>
    <div class="toast" id="toast"></div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { IFCLoader } from 'three/addons/loaders/IFCLoader.js';

    // ---------- UI helpers ----------
    const $ = (id) => document.getElementById(id);
    const statusEl = $('status');
    const toastEl = $('toast');

    function setStatus(msg){ statusEl.textContent = msg; }
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(() => toastEl.classList.remove('show'), 1800);
    }

    // ---------- Three.js setup ----------
    const canvas = $('c');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true, preserveDrawingBuffer:false });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;

    const scene = new THREE.Scene();

    const camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.01, 5000);
    camera.position.set(8, 6, 10);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;

    // Lights
    const hemi = new THREE.HemisphereLight(0xffffff, 0x223355, 0.9);
    scene.add(hemi);

    const dir = new THREE.DirectionalLight(0xffffff, 1.2);
    dir.position.set(10, 18, 12);
    scene.add(dir);

    // Ground shadow feel (subtle)
    const grid = new THREE.GridHelper(50, 50, 0x223355, 0x16233f);
    grid.material.opacity = 0.12;
    grid.material.transparent = true;
    scene.add(grid);

    let darkBg = true;
    function applyBackground(){
      // Só alterna a transparência do canvas vs cor sólida (mantém estética)
      if(darkBg){
        renderer.setClearColor(0x000000, 0); // transparente (usa o fundo do body)
      }else{
        renderer.setClearColor(0xf7fafc, 1); // sólido claro
      }
    }
    applyBackground();

    // ---------- IFC Loader (Three.js official) ----------
    const ifcLoader = new IFCLoader();

    // IMPORTANT: aponta para os WASM do loader IFC do Three.js (no CDN).
    // Isso evita 404 e resolve a "tela preta" no GitHub Pages.
    // (mantém a mesma versão do Three do importmap)
    const IFC_WASM_PATH = 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/ifc/';
    ifcLoader.ifcManager.setWasmPath(IFC_WASM_PATH);

    let currentModel = null;

    function clearModel(){
      if(!currentModel) return;
      scene.remove(currentModel);

      // limpa geometria/material
      currentModel.traverse((obj) => {
        if(obj.isMesh){
          obj.geometry?.dispose?.();
          if(obj.material){
            if(Array.isArray(obj.material)) obj.material.forEach(m => m.dispose?.());
            else obj.material.dispose?.();
          }
        }
      });

      currentModel = null;
      toast('Modelo removido.');
      setStatus('Ready');
    }

    function fitToObject(obj){
      const box = new THREE.Box3().setFromObject(obj);
      const size = box.getSize(new THREE.Vector3());
      const center = box.getCenter(new THREE.Vector3());

      const maxSize = Math.max(size.x, size.y, size.z);
      const dist = maxSize * 1.4;

      const dir = new THREE.Vector3(1, 0.8, 1).normalize();
      camera.position.copy(center.clone().add(dir.multiplyScalar(dist)));
      camera.near = Math.max(dist / 1000, 0.01);
      camera.far = Math.max(dist * 50, 2000);
      camera.updateProjectionMatrix();

      controls.target.copy(center);
      controls.update();
    }

    async function loadIfcFromUrl(url){
      try{
        setStatus('Carregando IFC padrão...');
        clearModel();

        // IFCLoader.load usa fetch internamente; no GH Pages funciona se o arquivo existir.
        await new Promise((resolve, reject) => {
          ifcLoader.load(
            url,
            (model) => {
              currentModel = model;
              scene.add(model);
              fitToObject(model);
              setStatus('IFC carregado ✓');
              toast('IFC padrão carregado.');
              resolve();
            },
            undefined,
            (err) => reject(err)
          );
        });
      }catch(e){
        console.error(e);
        setStatus('Não foi possível carregar o IFC padrão.');
        toast('Falha ao abrir ALL_ACESS.ifc (verifique o nome e a pasta).');
      }
    }

    async function loadIfcFromFile(file){
      try{
        setStatus('Carregando IFC...');
        clearModel();

        const url = URL.createObjectURL(file);
        await new Promise((resolve, reject) => {
          ifcLoader.load(
            url,
            (model) => {
              URL.revokeObjectURL(url);
              currentModel = model;
              scene.add(model);
              fitToObject(model);
              setStatus('IFC carregado ✓');
              toast('IFC carregado.');
              resolve();
            },
            undefined,
            (err) => {
              URL.revokeObjectURL(url);
              reject(err);
            }
          );
        });
      }catch(e){
        console.error(e);
        setStatus('Erro ao carregar IFC.');
        toast('Falha ao carregar o ficheiro IFC.');
      }
    }

    // ---------- Events / UI ----------
    $('resetBtn').addEventListener('click', () => {
      controls.reset();
      toast('Vista resetada.');
    });

    $('fitBtn').addEventListener('click', () => {
      if(currentModel) fitToObject(currentModel);
      else toast('Nenhum modelo carregado.');
    });

    $('bgBtn').addEventListener('click', () => {
      darkBg = !darkBg;
      applyBackground();
      toast(darkBg ? 'Fundo escuro' : 'Fundo claro');
    });

    $('fsBtn').addEventListener('click', async () => {
      try{
        if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
        else await document.exitFullscreen();
      }catch(e){
        console.warn(e);
      }
    });

    $('openBtn').addEventListener('click', () => $('fileInput').click());
    $('clearBtn').addEventListener('click', clearModel);

    $('fileInput').addEventListener('change', (ev) => {
      const file = ev.target.files?.[0];
      if(file) loadIfcFromFile(file);
      ev.target.value = '';
    });

    // Drag & drop
    window.addEventListener('dragover', (e) => { e.preventDefault(); });
    window.addEventListener('drop', (e) => {
      e.preventDefault();
      const file = e.dataTransfer?.files?.[0];
      if(file && /\.ifc$/i.test(file.name)) loadIfcFromFile(file);
      else toast('Solte um ficheiro .ifc');
    });

    // Resize
    window.addEventListener('resize', () => {
      const w = window.innerWidth, h = window.innerHeight;
      renderer.setSize(w, h);
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
    });

    // ---------- Render loop ----------
    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    // ---------- Auto-load default IFC ----------
    // IMPORTANT: precisa estar na mesma pasta e com o nome EXATO.
    loadIfcFromUrl('./ALL_ACESS.ifc');
  </script>
</body>
</html>
