<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IFC Interactive Viewer</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg0:#061022; --panel:rgba(12,18,26,.55);
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --chip:rgba(255,255,255,.08);
      --chip2:rgba(255,255,255,.12);
      --good:#2ecc71; --warn:#f39c12; --bad:#e74c3c;
      --r:14px;
    }
    html,body{height:100%; margin:0; background:radial-gradient(1200px 800px at 25% 15%, #0b2b52, var(--bg0)); overflow:hidden; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}
    #app{position:fixed; inset:0;}
    canvas{display:block; width:100%; height:100%;}

    .topbar{position:fixed; top:16px; left:16px; right:16px; display:flex; justify-content:space-between; gap:12px; pointer-events:none;}
    .badge{pointer-events:auto; display:inline-flex; align-items:flex-start; gap:10px; padding:10px 12px; border-radius:var(--r);
      background:var(--panel); border:1px solid var(--stroke); backdrop-filter: blur(10px);
      box-shadow:0 10px 28px rgba(0,0,0,.28);
      max-width:min(540px, 92vw);
    }
    .badge .icon{width:28px; height:28px; border-radius:10px; display:grid; place-items:center; background:rgba(255,255,255,.06); border:1px solid var(--stroke); font-weight:800;}
    .badge h1{font-size:13px; line-height:1.2; margin:0; color:var(--text); letter-spacing:.2px;}
    .badge p{font-size:11px; margin:2px 0 0; color:var(--muted);}

    .actions{pointer-events:auto; display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end;}
    .btn{appearance:none; border:1px solid var(--stroke); background:var(--chip);
      color:var(--text); padding:8px 10px; border-radius:12px; font-size:12px; cursor:pointer;
      transition:transform .05s ease, background .15s ease, border-color .15s ease;
    }
    .btn:hover{background:var(--chip2); border-color:rgba(255,255,255,.18)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:rgba(46,204,113,.12); border-color:rgba(46,204,113,.35)}

    .panel{position:fixed; left:16px; bottom:16px; width:min(520px, calc(100vw - 32px));
      background:var(--panel); border:1px solid var(--stroke); border-radius:16px; backdrop-filter: blur(10px);
      box-shadow:0 10px 28px rgba(0,0,0,.28); padding:12px;
    }
    .panel .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .panel .hint{margin-top:10px; color:var(--muted); font-size:11px; line-height:1.35;}
    .panel .hint b{color:var(--text)}
    .file{display:flex; gap:8px; align-items:center; flex:1 1 260px;}
    input[type=file]{max-width:100%}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px; border:1px solid var(--stroke); background:rgba(255,255,255,.06); color:var(--text); font-size:12px;}

    #toast{position:fixed; right:16px; bottom:16px; padding:10px 12px; border-radius:12px;
      border:1px solid var(--stroke); background:rgba(0,0,0,.35); color:var(--text);
      font-size:12px; max-width:min(420px, calc(100vw - 32px)); backdrop-filter: blur(10px);
      box-shadow:0 10px 28px rgba(0,0,0,.28);
      transform: translateY(12px); opacity:0; pointer-events:none; transition: all .18s ease;
      white-space:pre-line;
    }
    #toast.show{transform: translateY(0); opacity:1;}
    #toast.good{border-color:rgba(46,204,113,.35)}
    #toast.warn{border-color:rgba(243,156,18,.35)}
    #toast.bad{border-color:rgba(231,76,60,.38)}

    #status{position:fixed; right:16px; bottom:16px; transform: translateY(-62px);}

    @media (max-width:560px){
      .topbar{top:12px; left:12px; right:12px}
      .panel{left:12px; right:12px; bottom:12px; width:auto}
      #toast{right:12px; bottom:12px}
      #status{right:12px; bottom:12px; transform: translateY(-66px)}
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <div class="topbar">
    <div class="badge">
      <div class="icon">IFC</div>
      <div>
        <h1>IFC Interactive Viewer</h1>
        <p>Revit ‚Üí IFC ‚Ä¢ abre um IFC padr√£o ‚Ä¢ permite carregar outro ficheiro local</p>
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="resetBtn">Reset view</button>
      <button class="btn" id="fitBtn">Fit model</button>
      <button class="btn" id="bgBtn">Toggle background</button>
      <button class="btn primary" id="fsBtn">Fullscreen</button>
    </div>
  </div>

  <div class="panel">
    <div class="row">
      <span class="pill">üß© Open IFC</span>
      <div class="file">
        <input id="fileInput" type="file" accept=".ifc" />
        <button class="btn" id="clearBtn">Clear</button>
      </div>
      <span class="pill" id="readyPill">Ready</span>
    </div>
    <div class="hint">
      ‚Ä¢ O modelo padr√£o <b>ALL_ACESS.ifc</b> abre automaticamente (se estiver na mesma pasta do <b>index.html</b> no GitHub Pages).<br>
      ‚Ä¢ Voc√™ tamb√©m pode arrastar e soltar um IFC nesta p√°gina, ou clicar em <b>Escolher ficheiro</b>.<br>
      ‚Ä¢ No GitHub Pages, o nome do ficheiro tem de bater exatamente (mai√∫sculas/min√∫sculas).
    </div>
  </div>

  <div id="status" class="pill">Carregando‚Ä¶</div>
  <div id="toast"></div>

  <script type="module">
    // Imports diretos (sem importmap) -> menos pontos de falha
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js';
    import { IFCLoader } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/IFCLoader.js';

    const app = document.getElementById('app');
    const toast = document.getElementById('toast');
    const statusEl = document.getElementById('status');
    const fileInput = document.getElementById('fileInput');
    const readyPill = document.getElementById('readyPill');

    const resetBtn = document.getElementById('resetBtn');
    const fitBtn = document.getElementById('fitBtn');
    const bgBtn = document.getElementById('bgBtn');
    const fsBtn = document.getElementById('fsBtn');
    const clearBtn = document.getElementById('clearBtn');

    function showToast(msg, type='warn', ms=5200){
      toast.className = '';
      toast.classList.add('show', type);
      toast.textContent = msg;
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.classList.remove('show'), ms);
    }
    function setStatus(msg){
      statusEl.textContent = msg;
      readyPill.textContent = msg;
    }

    // Three.js
    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false, powerPreference:'high-performance' });
    renderer.setPixelRatio(Math.min(devicePixelRatio || 1, 2));
    renderer.setSize(innerWidth, innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    app.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x061022);

    const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 2000);
    camera.position.set(10, 8, 12);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.06;
    controls.target.set(0, 1, 0);

    scene.add(new THREE.HemisphereLight(0xffffff, 0x223355, 0.75));
    const dir = new THREE.DirectionalLight(0xffffff, 0.9);
    dir.position.set(10, 18, 8);
    scene.add(dir);

    const grid = new THREE.GridHelper(40, 40, 0x223344, 0x112233);
    grid.material.transparent = true;
    grid.material.opacity = 0.12;
    scene.add(grid);

    const modelRoot = new THREE.Group();
    scene.add(modelRoot);

    // IFC Loader
    const ifcLoader = new IFCLoader();

    // FIX CR√çTICO: o WASM tem de vir do pacote web-ifc (exemplo oficial do three)
    await ifcLoader.ifcManager.setWasmPath('https://cdn.jsdelivr.net/npm/web-ifc@0.0.36/', true);

    let currentIfc = null;

    function clearModel(){
      if(!currentIfc) return;
      modelRoot.remove(currentIfc);
      currentIfc.traverse(o=>{
        o.geometry?.dispose?.();
        if(o.material){
          if(Array.isArray(o.material)) o.material.forEach(m=>m.dispose?.());
          else o.material.dispose?.();
        }
      });
      currentIfc = null;
      renderer.render(scene, camera);
    }

    function fitToObject(obj){
      const box = new THREE.Box3().setFromObject(obj);
      if(!isFinite(box.min.x) || !isFinite(box.max.x)) return;
      const size = box.getSize(new THREE.Vector3());
      const center = box.getCenter(new THREE.Vector3());
      const maxDim = Math.max(size.x, size.y, size.z);
      const fov = camera.fov * Math.PI / 180;
      let dist = (maxDim / 2) / Math.tan(fov / 2);
      dist *= 1.35;

      const dirVec = new THREE.Vector3(1, 0.6, 1).normalize();
      camera.position.copy(center.clone().add(dirVec.multiplyScalar(dist)));
      camera.near = Math.max(0.01, dist / 200);
      camera.far = dist * 30;
      camera.updateProjectionMatrix();
      controls.target.copy(center);
      controls.update();
    }

    async function loadIFCFromUrl(url){
      setStatus('Carregando IFC‚Ä¶');
      try{
        const ifcModel = await new Promise((resolve, reject)=>{
          ifcLoader.load(url, resolve, undefined, reject);
        });
        clearModel();
        currentIfc = ifcModel;
        modelRoot.add(ifcModel);
        fitToObject(ifcModel);
        setStatus('Ready');
        showToast('IFC carregado com sucesso.', 'good', 2500);
      }catch(e){
        console.error(e);
        setStatus('Erro');
        showToast(
          'N√£o foi poss√≠vel carregar o IFC.\n' +
          '‚Ä¢ Confirme que ALL_ACESS.ifc est√° na mesma pasta do index.html\n' +
          '‚Ä¢ Em file:// o IFC padr√£o n√£o carrega: use GitHub Pages (https://)\n' +
          'Detalhe: ' + (e?.message || e),
          'bad', 9000
        );
      }
    }

    async function loadIFCFromFile(file){
      if(!file) return;
      const url = URL.createObjectURL(file);
      await loadIFCFromUrl(url);
      URL.revokeObjectURL(url);
    }

    // UI
    fileInput.addEventListener('change', (ev)=>{
      const f = ev.target.files?.[0];
      loadIFCFromFile(f);
      ev.target.value = '';
    });

    window.addEventListener('dragover', (e)=>e.preventDefault());
    window.addEventListener('drop', (e)=>{
      e.preventDefault();
      const f = e.dataTransfer?.files?.[0];
      if(f && (f.name||'').toLowerCase().endsWith('.ifc')) loadIFCFromFile(f);
      else showToast('Solte um ficheiro .ifc v√°lido.', 'warn');
    });

    resetBtn.addEventListener('click', ()=>{
      if(currentIfc) fitToObject(currentIfc);
      else {
        camera.position.set(10,8,12);
        controls.target.set(0,1,0);
        controls.update();
      }
    });
    fitBtn.addEventListener('click', ()=>{ if(currentIfc) fitToObject(currentIfc); });

    let bgDark = true;
    bgBtn.addEventListener('click', ()=>{
      bgDark = !bgDark;
      scene.background = new THREE.Color(bgDark ? 0x061022 : 0x0f1724);
      renderer.render(scene, camera);
    });

    fsBtn.addEventListener('click', async ()=>{
      try{
        if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
        else await document.exitFullscreen();
      }catch{
        showToast('Fullscreen n√£o suportado.', 'warn');
      }
    });

    clearBtn.addEventListener('click', ()=>{
      clearModel();
      setStatus('Ready');
      showToast('Modelo removido.', 'warn', 2200);
    });

    addEventListener('resize', ()=>{
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });

    (function tick(){
      controls.update();
      renderer.render(scene, camera);
      requestAnimationFrame(tick);
    })();

    // Auto-load IFC padr√£o
    if(location.protocol === 'file:'){
      setStatus('Ready');
      showToast('Abrindo via file://. O IFC padr√£o n√£o carrega automaticamente.\nUse GitHub Pages (https://) ou carregue um IFC local.', 'warn', 9000);
    } else {
      loadIFCFromUrl('ALL_ACESS.ifc');
    }
  </script>
</body>
</html>
