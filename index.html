<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IFC Interactive Viewer</title>
  <style>
    html, body { margin:0; height:100%; background:#071224; overflow:hidden; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #app { position:fixed; inset:0; }
    canvas { display:block; width:100%; height:100%; }

    /* Top-left badge */
    .badge{
      position:fixed; left:14px; top:14px;
      background:rgba(18,28,45,.75);
      backdrop-filter: blur(10px);
      border:1px solid rgba(255,255,255,.10);
      color:#eaf2ff; border-radius:14px;
      padding:10px 12px; line-height:1.15;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      max-width: 360px;
    }
    .badge .t{ font-weight:700; font-size:14px; letter-spacing:.2px; display:flex; gap:10px; align-items:center; }
    .badge .t .pill{ font-weight:800; font-size:12px; padding:2px 8px; border-radius:999px; background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.10); }
    .badge .s{ margin-top:4px; font-size:12px; opacity:.85; }

    /* Top-right actions */
    .actions{
      position:fixed; right:14px; top:14px;
      display:flex; gap:10px; align-items:center;
    }
    .btn{
      cursor:pointer; user-select:none;
      padding:8px 10px; border-radius:12px;
      background:rgba(18,28,45,.72);
      color:#eaf2ff; border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      font-size:12px; font-weight:700;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .btn:hover{ background:rgba(28,40,62,.75); }
    .btn.primary{ background:rgba(22,117,84,.75); border-color: rgba(46,204,148,.25); }
    .btn.primary:hover{ background:rgba(22,117,84,.9); }

    /* Bottom-left panel */
    .panel{
      position:fixed; left:14px; bottom:14px;
      background:rgba(18,28,45,.72);
      backdrop-filter: blur(10px);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:10px 12px;
      color:#eaf2ff;
      width:min(520px, calc(100vw - 28px));
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
    }
    .panel .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .panel input[type="file"]{ display:none; }
    .hint{ margin-top:8px; font-size:11px; opacity:.78; line-height:1.3; }
    .chip{
      font-size:11px;
      padding:6px 8px;
      border-radius:12px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
    }

    /* Bottom-right status */
    .status{
      position:fixed; right:14px; bottom:14px;
      background:rgba(18,28,45,.72);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      border-radius:14px;
      padding:8px 10px;
      color:#eaf2ff;
      font-size:12px;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      min-width: 220px;
    }
    .status .dot{
      display:inline-block; width:9px; height:9px; border-radius:999px;
      background:#2ecc94; margin-right:8px; vertical-align:middle;
      box-shadow: 0 0 0 3px rgba(46,204,148,.15);
    }
    .status .sub{ font-size:11px; opacity:.78; margin-top:2px; }

    /* Mobile tweaks */
    @media (max-width: 560px){
      .actions{ right:10px; top:10px; gap:8px; }
      .badge{ left:10px; top:10px; max-width: 70vw; }
      .panel{ left:10px; bottom:10px; width: calc(100vw - 20px); }
      .status{ right:10px; bottom:10px; }
      .btn{ padding:7px 9px; border-radius:11px; }
    }
  </style>
</head>

<body>
  <div id="app"></div>

  <div class="badge">
    <div class="t"><span class="pill">IFC</span> IFC Interactive Viewer</div>
    <div class="s">Revit → IFC • abre um IFC padrão • permite carregar outro ficheiro local</div>
  </div>

  <div class="actions">
    <div class="btn" id="btnReset">Reset view</div>
    <div class="btn" id="btnFit">Fit model</div>
    <div class="btn" id="btnBg">Toggle background</div>
    <div class="btn primary" id="btnFs">Fullscreen</div>
  </div>

  <div class="panel">
    <div class="row">
      <div class="btn" id="btnOpen">Open IFC</div>
      <label class="btn" for="file">Escolher ficheiro</label>
      <input id="file" type="file" accept=".ifc" />
      <div class="btn" id="btnClear">Clear</div>
      <div class="chip" id="chipName">ALL_ACESS.ifc</div>
      <div class="chip" id="chipState">Ready</div>
    </div>
    <div class="hint">
      • O modelo padrão <b>ALL_ACESS.ifc</b> abre automaticamente (se estiver na mesma pasta do <b>index.html</b> no GitHub Pages).<br/>
      • Você também pode arrastar/soltar um IFC nesta página, ou clicar em <b>Escolher ficheiro</b>.<br/>
      • No GitHub Pages, o nome do ficheiro tem de bater exatamente (maiúsculas/minúsculas).
    </div>
  </div>

  <div class="status" id="status">
    <div><span class="dot"></span><span id="statusText">Ready</span></div>
    <div class="sub" id="statusSub">Abra um IFC. Use mouse/touch para orbitar/zoom/pan.</div>
  </div>

  <script type="module">
    // ✅ CDN ESM estável para GitHub Pages
    // - esm.sh resolve dependências e funciona bem com modules no browser
    // - web-ifc WASM via jsDelivr (estável para .wasm)
    import * as THREE from "https://esm.sh/three@0.160.0";
    import { OrbitControls } from "https://esm.sh/three@0.160.0/examples/jsm/controls/OrbitControls.js";
    import { IFCLoader } from "https://esm.sh/three@0.160.0/addons/loaders/IFCLoader.js";

    const DEFAULT_IFC = "ALL_ACESS.ifc";
    const WEB_IFC_WASM = "https://cdn.jsdelivr.net/npm/web-ifc@0.0.57/"; // contém web-ifc.wasm

    const app = document.getElementById("app");
    const fileInput = document.getElementById("file");
    const chipName = document.getElementById("chipName");
    const chipState = document.getElementById("chipState");
    const statusText = document.getElementById("statusText");
    const statusSub  = document.getElementById("statusSub");

    function setStatus(main, sub, stateChip){
      statusText.textContent = main ?? "";
      if (sub !== undefined) statusSub.textContent = sub ?? "";
      if (stateChip !== undefined) chipState.textContent = stateChip ?? "";
    }

    // Renderer / Scene
    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false });
    renderer.setPixelRatio(Math.min(2, window.devicePixelRatio || 1));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    app.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x071224);

    const camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 5000);
    camera.position.set(10, 8, 14);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.07;
    controls.target.set(0, 1.2, 0);

    // Lights
    const hemi = new THREE.HemisphereLight(0xffffff, 0x233044, 0.9);
    scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 1.0);
    dir.position.set(15, 25, 10);
    dir.castShadow = false;
    scene.add(dir);

    // IFC Loader
    const ifcLoader = new IFCLoader();
    // web-ifc needs the WASM path; jsDelivr funciona bem no GitHub Pages
    ifcLoader.ifcManager.setWasmPath(WEB_IFC_WASM);

    let currentModel = null;

    function clearModel(){
      if (!currentModel) return;
      scene.remove(currentModel);
      // tentar limpar geometria/materiais para liberar memória
      currentModel.traverse?.((obj)=>{
        if (obj.geometry) obj.geometry.dispose?.();
        if (obj.material){
          if (Array.isArray(obj.material)) obj.material.forEach(m=>m.dispose?.());
          else obj.material.dispose?.();
        }
      });
      currentModel = null;
    }

    function fitToObject(object3d){
      const box = new THREE.Box3().setFromObject(object3d);
      const size = box.getSize(new THREE.Vector3());
      const center = box.getCenter(new THREE.Vector3());

      const maxDim = Math.max(size.x, size.y, size.z);
      const fov = camera.fov * (Math.PI / 180);
      let cameraZ = Math.abs((maxDim / 2) / Math.tan(fov / 2));
      cameraZ *= 1.6;

      camera.position.set(center.x + cameraZ, center.y + cameraZ * 0.4, center.z + cameraZ);
      camera.near = Math.max(0.01, maxDim / 1000);
      camera.far  = Math.max(5000, maxDim * 20);
      camera.updateProjectionMatrix();

      controls.target.copy(center);
      controls.update();
    }

    async function loadIFCFromUrl(url, label){
      setStatus("Carregando…", `A abrir: ${label || url}`, "Carregando…");
      chipName.textContent = label || url;

      return new Promise((resolve, reject)=>{
        try{
          ifcLoader.load(
            url,
            (model)=>{
              clearModel();
              currentModel = model;
              scene.add(model);
              fitToObject(model);
              setStatus("Ready", "Modelo carregado. Use mouse/touch para orbitar/zoom/pan.", "Ready");
              resolve(model);
            },
            (xhr)=>{
              // progresso opcional
              if (xhr?.total){
                const p = Math.round((xhr.loaded / xhr.total) * 100);
                setStatus("Carregando…", `Download: ${p}%`, "Carregando…");
              }
            },
            (err)=>{
              console.error(err);
              setStatus("Erro", "Falha ao carregar IFC. Verifique console e se o ficheiro existe.", "Erro");
              reject(err);
            }
          );
        }catch(e){
          console.error(e);
          setStatus("Erro", "Exceção ao iniciar o loader. Verifique console.", "Erro");
          reject(e);
        }
      });
    }

    async function loadIFCFile(file){
      const url = URL.createObjectURL(file);
      try{
        await loadIFCFromUrl(url, file.name);
      } finally {
        // revogar após carregar (não revogar antes do callback)
        setTimeout(()=>URL.revokeObjectURL(url), 1500);
      }
    }

    // Default auto-load (GitHub Pages)
    async function tryAutoLoadDefault(){
      // Faz um fetch simples para confirmar que existe (evita ficar “preto” sem feedback)
      try{
        const res = await fetch(DEFAULT_IFC, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        // carrega pelo loader (ele refaz o fetch internamente, mas já sabemos que existe)
        await loadIFCFromUrl(DEFAULT_IFC, DEFAULT_IFC);
      }catch(e){
        console.warn("Default IFC not loaded:", e);
        setStatus("Ready", "Nenhum IFC padrão encontrado. Use 'Escolher ficheiro' ou drag&drop.", "Ready");
        chipName.textContent = DEFAULT_IFC;
      }
    }

    // UI bindings (mantendo layout)
    document.getElementById("btnOpen").addEventListener("click", ()=> fileInput.click());
    fileInput.addEventListener("change", async (e)=>{
      const file = e.target.files?.[0];
      if (!file) return;
      await loadIFCFile(file);
      fileInput.value = "";
    });

    document.getElementById("btnClear").addEventListener("click", ()=>{
      clearModel();
      setStatus("Ready", "Modelo removido. Abra outro IFC.", "Ready");
      chipName.textContent = DEFAULT_IFC;
    });

    document.getElementById("btnFit").addEventListener("click", ()=>{
      if (currentModel) fitToObject(currentModel);
    });

    document.getElementById("btnReset").addEventListener("click", ()=>{
      if (currentModel) fitToObject(currentModel);
      else {
        camera.position.set(10, 8, 14);
        controls.target.set(0, 1.2, 0);
        controls.update();
      }
    });

    let darkBg = true;
    document.getElementById("btnBg").addEventListener("click", ()=>{
      darkBg = !darkBg;
      scene.background = new THREE.Color(darkBg ? 0x071224 : 0xf2f5fb);
    });

    document.getElementById("btnFs").addEventListener("click", async ()=>{
      try{
        if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
        else await document.exitFullscreen();
      }catch(e){}
    });

    // Drag & drop
    window.addEventListener("dragover", (e)=>{ e.preventDefault(); });
    window.addEventListener("drop", async (e)=>{
      e.preventDefault();
      const file = e.dataTransfer?.files?.[0];
      if (file && file.name.toLowerCase().endsWith(".ifc")){
        await loadIFCFile(file);
      }
    });

    // Resize
    window.addEventListener("resize", ()=>{
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // Render loop
    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    // Start
    tryAutoLoadDefault();
  </script>
</body>
</html>
