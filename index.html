<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Interactive IFC Viewer • Revit</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:rgba(255,255,255,.08);
      --panel2:rgba(255,255,255,.12);
      --border:rgba(255,255,255,.14);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.72);
      --accent:#2dd4bf;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --r:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    html,body{height:100%;margin:0;background:radial-gradient(1400px 900px at 50% 15%, #172554 0%, var(--bg) 58%, #050813 100%);color:var(--text);font-family:var(--sans);}
    *{box-sizing:border-box;}

    .topbar{
      position:fixed; inset:16px 16px auto 16px; z-index:20;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 12px;
      background:linear-gradient(180deg,var(--panel2),var(--panel));
      border:1px solid var(--border);
      border-radius:999px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:10px; min-width:0;}
    .badge{
      width:30px;height:30px;border-radius:10px;
      display:grid;place-items:center;
      background:rgba(45,212,191,.14);
      border:1px solid rgba(45,212,191,.35);
      color:var(--accent);
      font-weight:800;
    }
    .brand h1{margin:0;font-size:14px;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .brand .sub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    .btns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
    button{
      border:1px solid var(--border);
      background:rgba(255,255,255,.08);
      color:var(--text);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      cursor:pointer;
      transition:transform .12s ease, background .12s ease;
      user-select:none;
    }
    button:hover{background:rgba(255,255,255,.12);transform:translateY(-1px);}
    button.primary{border-color:rgba(45,212,191,.5);background:rgba(45,212,191,.14);}
    button.primary:hover{background:rgba(45,212,191,.18);}

    #viewer{
      position:fixed; inset:0;
    }

    .bottom{
      position:fixed; left:16px; bottom:16px; z-index:20;
      width:min(760px, calc(100vw - 32px));
      background:linear-gradient(180deg,var(--panel2),var(--panel));
      border:1px solid var(--border);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      padding:12px;
      display:grid;
      grid-template-columns: 1fr auto auto;
      gap:10px;
      align-items:center;
    }
    .help{min-width:0;}
    .help b{display:block;font-size:12px;margin-bottom:4px;}
    .help span{display:block;font-size:12px;color:var(--muted);line-height:1.35;}
    .help code{font-family:var(--mono);font-size:11px;background:rgba(0,0,0,.25);padding:2px 6px;border-radius:999px;border:1px solid rgba(255,255,255,.12)}

    .file{display:flex;gap:8px;align-items:center;justify-content:flex-end;}
    input[type=file]{display:none;}
    label.filebtn{
      border:1px dashed rgba(255,255,255,.25);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      cursor:pointer;
    }
    label.filebtn:hover{background:rgba(255,255,255,.10)}

    .toast{
      position:fixed; right:16px; bottom:16px; z-index:30;
      width:min(360px, calc(100vw - 32px));
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.35);
      color:var(--text);
      backdrop-filter: blur(10px);
      box-shadow:var(--shadow);
      font-size:12px;
      display:none;
    }
    .toast.show{display:block;}
    .toast .muted{color:var(--muted)}

    @media (max-width: 820px){
      .topbar{inset:10px 10px auto 10px; border-radius:18px; padding:10px;}
      .btns{gap:6px;}
      button{padding:8px 9px;}
      .bottom{left:10px;right:10px;bottom:10px;width:auto;grid-template-columns:1fr;}
      .file{justify-content:flex-start;flex-wrap:wrap;}
    }
  </style>
</head>
<body>
  <div id="viewer"></div>

  <div class="topbar" role="banner">
    <div class="brand">
      <div class="badge">IFC</div>
      <div style="min-width:0">
        <h1>Interactive IFC Viewer</h1>
        <div class="sub">Revit → IFC • modelo padrão + upload local (sem link)</div>
      </div>
    </div>
    <div class="btns">
      <button id="btnFit" class="primary">Fit model</button>
      <button id="btnReset">Reset view</button>
      <button id="btnBG">Toggle background</button>
      <button id="btnFS">Fullscreen</button>
    </div>
  </div>

  <div class="bottom" role="region" aria-label="Upload e ajuda">
    <div class="help">
      <b>Como usar</b>
      <span>
        • O ficheiro padrão <code>ALL_ACESS.ifc</code> é carregado automaticamente (se estiver na mesma pasta deste HTML).<br>
        • Para abrir outro IFC, clique em <b>Escolher ficheiro</b> (o browser lê localmente).<br>
        • Dica: use dois dedos (touch) para zoom/pan.
      </span>
    </div>
    <div class="file">
      <label class="filebtn" for="fileInput">Escolher ficheiro</label>
      <input id="fileInput" type="file" accept=".ifc" />
      <button id="btnClear" title="Limpar modelo atual">Clear</button>
    </div>
  </div>

  <div id="toast" class="toast" aria-live="polite"></div>

  <!--
    Por que o seu estava preto / com erros?
    - O IFCLoader do three/examples foi bloqueado por CORS no unpkg (e em alguns casos 404).
    - Aqui usamos web-ifc-viewer via jsDelivr (CORS OK no GitHub Pages).
  -->

  <script type="module">
    // CDN com CORS compatível com GitHub Pages
    import { IfcViewerAPI } from 'https://cdn.jsdelivr.net/npm/web-ifc-viewer@1.0.218/dist/ifc-viewer-api.js';

    const viewerContainer = document.getElementById('viewer');
    const toast = document.getElementById('toast');

    function showToast(msg, sub=''){
      toast.innerHTML = `<div>${msg}</div>${sub ? `<div class="muted" style="margin-top:4px">${sub}</div>` : ''}`;
      toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.classList.remove('show'), 4200);
    }

    // Inicializa o viewer
    const viewer = new IfcViewerAPI({ container: viewerContainer, backgroundColor: new (window.THREE?.Color ?? Object)(0x0b1220) });

    // Se THREE não estiver no window (depende do bundle), a API ainda funciona;
    // background será ajustado no toggle.

    // Grade e eixos para orientação
    viewer.grid.setGrid();
    viewer.axes.setAxes();

    // Melhorias de performance e UX
    viewer.context.renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));

    // Funções
    async function loadDefault(){
      try{
        // Carrega o IFC padrão a partir do mesmo diretório do HTML
        await viewer.IFC.loadIfcUrl('ALL_ACESS.ifc');
        await viewer.shadowDropper.renderShadow(viewer.IFC.loader.ifcManager.ifcModels[0]);
        await viewer.context.fitToFrame();
        showToast('Modelo padrão carregado.', 'ALL_ACESS.ifc');
      }catch(err){
        console.error(err);
        showToast('Não foi possível carregar ALL_ACESS.ifc.', 'Confirme que o ficheiro está na mesma pasta do HTML (GitHub Pages: mesma pasta) e que o nome está correto.');
      }
    }

    async function loadFromFile(file){
      if(!file) return;
      try{
        // Limpa modelos existentes
        await viewer.IFC.loader.ifcManager.dispose();
        viewer.context.items.ifcModels.forEach(m=>viewer.context.scene.remove(m));
        viewer.context.items.ifcModels.length = 0;

        const url = URL.createObjectURL(file);
        await viewer.IFC.loadIfcUrl(url);
        URL.revokeObjectURL(url);

        // Sombra + enquadramento
        const model = viewer.IFC.loader.ifcManager.ifcModels[0];
        if(model) await viewer.shadowDropper.renderShadow(model);
        await viewer.context.fitToFrame();
        showToast('IFC carregado.', file.name);
      }catch(err){
        console.error(err);
        showToast('Falha ao carregar o IFC.', String(err?.message || err));
      }
    }

    function clearScene(){
      try{
        viewer.IFC.loader.ifcManager.dispose();
        viewer.context.items.ifcModels.forEach(m=>viewer.context.scene.remove(m));
        viewer.context.items.ifcModels.length = 0;
        showToast('Cena limpa.');
      }catch(e){
        console.warn(e);
      }
    }

    // UI events
    document.getElementById('btnFit').addEventListener('click', ()=>viewer.context.fitToFrame());
    document.getElementById('btnReset').addEventListener('click', ()=>viewer.context.setOrbitControls());

    let bgDark = true;
    document.getElementById('btnBG').addEventListener('click', ()=>{
      bgDark = !bgDark;
      const c = bgDark ? 0x0b1220 : 0xf8fafc;
      try{
        viewer.context.scene.background = new viewer.context.THREE.Color(c);
      }catch{
        // fallback
        viewerContainer.style.background = bgDark ? '#0b1220' : '#f8fafc';
      }
    });

    document.getElementById('btnFS').addEventListener('click', async ()=>{
      const el = document.documentElement;
      if(!document.fullscreenElement){
        await el.requestFullscreen?.();
      } else {
        await document.exitFullscreen?.();
      }
    });

    document.getElementById('btnClear').addEventListener('click', clearScene);

    const fileInput = document.getElementById('fileInput');
    fileInput.addEventListener('change', (e)=> loadFromFile(e.target.files?.[0]));

    // Drag & drop
    window.addEventListener('dragover', (e)=>{ e.preventDefault(); });
    window.addEventListener('drop', (e)=>{
      e.preventDefault();
      const f = e.dataTransfer?.files?.[0];
      if(f && /\.ifc$/i.test(f.name)) loadFromFile(f);
    });

    // Carrega o default ao iniciar
    loadDefault();
  </script>
</body>
</html>
